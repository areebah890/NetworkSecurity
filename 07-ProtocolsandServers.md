---

# Protocols and Servers- Try Hack Me room

---

## Objective 
- introduction of commonly used protocols
1. HTTP
2. FTP
3. POP3
4. SMTP
5. IMAP
- discussion of some insecurities, focus on passwords sent in cleartext

--- 

<details>
<summary>Telnet</summary>

- application layer protocol used to connect a virtual terminal of another computer
- using telnet user can log into another computer and access its terminal (console) terminal
- can then run programs, start batch processes, perform system administration tasks all remotely

- all communication between Telnet client and Telnet server is not encrypted = easy target for attackers
- telnet server uses telnet protocol to listen for incoming connections on port 23

- example, user connect to the `telnetd` (a telnet server):
1. asked to provide login name (username), `frank`
2. asked for password,`D2xc9CgD` (not shown on screen usually)
3. system checks login credentials -> greeted w/ welcome message
4. the remote server grants command prompt `frank@bento:~$`. `$` = not root terminal

<img width="343" height="428" alt="image" src="https://github.com/user-attachments/assets/d169d544-19b9-4c11-97dc-113aea335dc6" />

- telnet have access remote system's terminal but not reliable protocol for remote administration
- b/c all data is sent in cleartext
- figure below captures traffic generated by Telnet - it was easy to find password
- shows ASCII data exchanged between our computer and remote system
- red text = what we send to remote system
- blue = text remote system is sending
- username was sent back (echoed at us to display them in our terminal)
- but password was not
- so if someone is watching us type -> won't be able to see password characters on the screen

<img width="916" height="602" alt="image" src="https://github.com/user-attachments/assets/bd655258-eb21-4e3f-94d9-e0b8a071527a" />

- Telnet no longer considered secure option
- especially that anyone capturing your network traffic is able to discover your username and passwords
- grants them the remote system
- secure alternative = SSH

  </details>


<details>
<summary>Hypertext Transfer Protocol (HTTP)</summary>

- HTTP = protocol used to transfer web [ages
- our web browser connects to webserver and uses HTT[ to request HTML pages, images among other files
- and submit forms and uplaod various files
- anytime we brows World Wide Web (WWW) we use HTTP protocol

- image below shows client requesting the HTML page `index.html` which the webserver provides
- then the client requested an image `logo.jpg` and web server sends it

<img width="882" height="316" alt="image" src="https://github.com/user-attachments/assets/205669a0-3bb9-4a31-9f03-38e84506e028" />

- HTTP sends and receives data as cleartext (not encrypted)
- so can use Telnet or Netcat to communicate w/ a web server and act as a 'web browser'
- key difference -> you need to input the HTTP-related commands instead of the web browser doing that for us

- example, see how we can request a page from a web server then discover the webserver version
- to accomplish this we use Telnet client (simple protocol, uses cleartext for communication)
- use telnet instead of web browser to request a file from the webserver

1. connect to port 80 using `telnet MACHINE_IP 80`
2. then type `GET /index.html HTTP/1.1` to retrieve page `index.html` or `GET / HTTP/1.1` to retrieve default page
3. finally, provide some value for host like `host: telent` and press enter key twice

- in console below we coul recover the requested page along w/ trove of info not usually displayed by web browser
- is page requested not found = error 404

<img width="368" height="383" alt="image" src="https://github.com/user-attachments/assets/8732b35c-17b8-4b42-a74a-fc14a76def74" />

- above the user needs only to type a couple of commands to get page they need
- `GET /index.html HTTP/1.1` followed by `host: telnet`

- we need HTTP server (webserver) and an HTTP client (web browser) to use the HTTP protocol
- web server will 'serve' a specific set of files to the requesting web browser

- popular HTTP servers are:
1. apache
2. internet information services (IIS)
3. nginx

- apache and nginx are free and open-source software
- IIS is closed source software, requires paying for license

- many web browsers are available, most popular:
1. chrome by google
2. edge by microsoft
3. firefox by mozilla
4. safari by apple

-  web browsers are generally free to install and use
-  tech giants battle for a higher market share for their browsers

--- 

Launch the attached VM. From the AttackBox terminal, connect using Telnet to 10.10.38.7 80 and retrieve the file flag.thm. What does it contain?

<img width="265" height="219" alt="image" src="https://github.com/user-attachments/assets/e2cec63d-b917-4f44-a5b6-e618b9a357c7" />

</details>


<details>
<summary>File Transfer Protocol (FTP)</summary>

- developed to make the transfer of files between different computers with different system efficient
- FTP sends and receives data as cleartext
- so we can use telnet or netcat to communicate with an FTP server and act as an FTP client

- example below carried out following steps
1. connected to an FTP server using telnet client , FTP listens in port 21 by default so we need to specify our Telnet client to attempt connection to port 21 instead of default telnet 23 port
2. we need to provide the username with command `USER frank`
3. then we provide password w/ `PASS D2xc9CgD`
4. b/c we supplied correct username and password we got logged in

- command like `STAT` can provide some added info
- `SYST` shows System Type of the target (UNIX in this case)
- `PASV` switches mode to passive
- there are two modes for FTP
1. Active mode: data is sent over a seperate channel originating from the FTP server's port 20
2. Passive mode: data is sent over a seperate channel originating from an FTP client's port above port number 1023

- command `TYPE A` switches file transfer mode to ASCII
- `TYPE I` switches file transfer mode binary
- but we can't transfer a file using a simple client like telnet b/c FTP creates a seperate connection for file transfer

<img width="345" height="409" alt="image" src="https://github.com/user-attachments/assets/6e427b5a-6df0-4600-aa96-760d086a7de6" />

- image below shows an actual transfer would be conducted using FTP
- we focus on the fact that FTP client will initiate a connection to an FTP server
- listen to port 21 by default
- all commands sent over control channel
- once client requests a file another TCP connection will be established between them

<img width="862" height="240" alt="image" src="https://github.com/user-attachments/assets/92b94c34-869d-4c84-9c92-c913d28f2974" />

- let's use an actual FTP client to download a text file
- only needed a small number of commands
- after logging successfully we get FTP prompt `ftp>` to execute varuous FTP commands
- used `ls` to list files and learn the file name
- then swirched to ascii since it is a text file not binary
- finally `get FILENAME` made client and server establish another channel for file transfer

<img width="377" height="367" alt="image" src="https://github.com/user-attachments/assets/aeeb9698-0bd5-4b89-95db-d1f7a9efab92" />

- FTP servers and FTP clients use FTP protocol
- there are various FTP server software that can select from if you want to host your FTP file server
- examples of FTP server software include:
1. vsftpd
2. ProFTPD
3. uFTP

- for FTP clients as well as console FTP client commonly found Linux systems you can use an FTP client with GUI file like FileZilla
- some web browsers also support FTP protocol
- b/c FTP sends login credentials along w/ commands and files in cleartext
- FTP traffic can be easy target for attackers

---

Using an FTP client, connect to the VM and try to recover the flag file. What is the flag?

<img width="632" height="421" alt="image" src="https://github.com/user-attachments/assets/1519690e-aef7-4524-a3b6-34e6429f3178" />

</details>


<details>
<summary>Simple Mail Transfer Protocol (SMTP)</summary>

- email is one of most used services on internet
- there's various configurations for email servers
- like you make set up email system to allow local users to exchange emails w/ each other -> w/ no access to internet
- but we will consider the more general setup -> different email servers connect over the internet

email delivery over the internet requires following components:
1. Mail Submission Agent (MSA)
2. Mail Transfer Agent (MTA)
3. Mail Delivery Agent (MDA)
4. Mail User Agent (MUA)

<img width="884" height="624" alt="image" src="https://github.com/user-attachments/assets/239b6637-c25b-4a6b-9931-6a593acfaf0b" />

figure shows **5 steps that an email must go through to reach recipient's inbox**

1. MUA (email client) has an email message to be sent, the MUA connects to a MSA to send its message
2. MSA receives the message, checks for any errors before transferring it to MTA server commonly hosted on the same server
3. MTA will send email message to MTA of the reciepient, the MTA can also function as MSA
4. type setup would have MTA server also function as MDA
5. reciepient will connect its email from the MDA using their email client

**anology**
1. you (MUA) wants to send postal mail
2. post office employee (MSA) checks postal mail for any issues before your local post office (MTA) accepts it
3. local post office checks the mail destination and send it to post office (MTA) inn correct country
4. post office (MTA) delivers the mail to the recipient mailbox (MDA)
5. recipient (MUA) regularly checks the mailbox for new mail - they notice the new mail and they take it

- we need to follow a protocol to communicate w/ an HTTP server and we rely on email protocols to talk w/ an MTA and an MDA
1. Simple Mail Transfer Protocol (SMTP)
2. Post Office Protocol version 3 (POP3) or Internet Message Access Protocol (IMAP)

- SMTP (Simple Mail Transfer Protocol) used to communicate with MTA 
- runs in cleartext = commands are not encrypted
- default listening port is 25
- you can connect to an SMTP server using Telnet.
- After connecting, use the command:
     - `HELO <hostname>` to introduce yourself.
- Then, proceed to type and send the email manually

<img width="264" height="293" alt="image" src="https://github.com/user-attachments/assets/c645807c-c877-4955-9fa0-d624c67e80c8" />

- After HELO, the client specifies:
      - MAIL FROM: → sender address
      - RCPT TO: → recipient address

- To send the actual email content:
     - Use the DATA command, then type the message body.
     - End the message with `<CR><LF>.<CR><LF>` (press Enter, type `.`, then press Enter again)

- the SMTP server then queues the message for delivery
- these commands show what a mail client does behind the scenes, don't need to memorise it

--- 

Using the AttackBox terminal, connect to the SMTP port of the target VM. What is the flag that you can get?

<img width="472" height="92" alt="image" src="https://github.com/user-attachments/assets/36b0f211-0aa2-49cf-a7dc-a68f8148e928" />

</details>


<details>
<summary>Post Office Protocol 3 (POP3)</summary>

- protocol is used to download the email messages from a Mail Delivery Agent (MDA) server
- shown in figure below
- mail client connects to POP3 server, authenticates, downloads the new email messages before (optionally) deleting them

 <img width="912" height="624" alt="image" src="https://github.com/user-attachments/assets/4d4c5de8-d38c-4c01-8240-69b50dd56fd0" />

- POP3 (port 110) allows retrieving emails from a server
- user must authenticate with
    - `USER <username>`
    - `PASS <password>`
 - `STAT` shows inbox status `+OK nn mm` ->
    - `nn` = number of messages
    - `mm` = size of bytes
  - `LIST` displays available messages
  - `RETR <n>` retrieves the message with index n
  - no need to memorise commands, they just illustrate how POP3 works

<img width="353" height="362" alt="image" src="https://github.com/user-attachments/assets/003c2142-3654-4389-9c46-c29cb352dc35" />

- commands are sent in cleartext
- using telnet was enough to authenticate and retrieve email message
- as the username and password are sent in cleartext = any third party watching the network traffic can steal the login credentials

- mail client (MUA) will connect to POP3 server (MDA) authenticate and download the messafes
- although communication using the POP3 protocol will be hidden behind a sleek interface
- similar commands will be issued as issued in Telnet session above

- By default, POP3 deletes emails from the server after download.
- This behavior can be changed in the mail client settings to keep emails on the server.
- Using POP3 across multiple clients is inconvenient, as read/unread status isn’t synced.
- To keep mailboxes synchronised, a protocol like IMAP should be used instead.

---

<img width="348" height="185" alt="image" src="https://github.com/user-attachments/assets/19e6f139-1c36-4520-8e10-584ff5b9248e" />


<img width="380" height="160" alt="image" src="https://github.com/user-attachments/assets/1b750f19-7d9a-4b88-83f5-6084feba0054" />

</details>


<details>
<summary>Internet Message Access Protocol (IMAP)</summary>

- IMAP more advanced than POP3 and allows email synchronisation across multiple devices
- actions like marking a messages as read on one device are reflected on all devices
- IMAP commands are sent via Telnet on default port 143
- each command must be preceded by a tag (e.g. `c1`, `c2`) to track responses
- common example commands:
    - `LOGIN username password` -> authenticate
    - `LIST "" "*"` -> list all mail folders
    - `EXAMINE INBOX` -> check inbox for new messages
- commands are shown for illustration, memorisation not required

<img width="368" height="373" alt="image" src="https://github.com/user-attachments/assets/6e6bda19-d1b4-4403-95df-006ef06baa55" />

- IMAP sends login credential in cleartext
- anyone watching network traffic is able to know Frank's username and password

</details>

---

## Summary 

- The session covered various network protocols, how they work, and their usage.
- Attackers are often interested in protocols like SMB (file/printer sharing), but this session focused on a few common protocols.
- One session/module cannot cover all network protocols.
- It is important to remember default port numbers for common protocols.
- Protocols were summarized in alphabetical order with their default ports for easy reference.

| Protocol | TCP Port | Application(s)       | Data Security | Encrypted Alternative |
|----------|----------|--------------------|---------------|---------------------|
| FTP      | 21       | File Transfer       | Cleartext     | FTPS / SFTP         |
| HTTP     | 80       | Worldwide Web       | Cleartext     | HTTPS (443)         |
| IMAP     | 143      | Email (MDA)         | Cleartext     | IMAPS (993)         |
| POP3     | 110      | Email (MDA)         | Cleartext     | POP3S (995)         |
| SMTP     | 25       | Email (MTA)         | Cleartext     | SMTPS / STARTTLS    |
| Telnet   | 23       | Remote Access       | Cleartext     | SSH (22)            |
